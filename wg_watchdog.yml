---
- name: Setup wireguard watchdog service
  hosts: all
  tasks:
    - name: Check that mandatory variables are defined
      ansible.builtin.assert:
        that:
          - wg_client_service_name is defined
        quiet: true

    - name: Make sure scripts directory exists
      ansible.builtin.file:
        path: /opt/ansible/scripts/
        state: directory
        mode: "0755"
      become: true

    - name: Copy watchdog script
      ansible.builtin.copy:
        src: restart_wg_client.py
        dest: /opt/ansible/scripts/restart_wg_client.py
        mode: "0775"
      become: true

    - name: Create wireguard watchdog service
      ansible.builtin.copy:
        dest: /etc/systemd/system/wg-watchdog.service
        # copy module doesn't provide ansible_managed, template_host, etc. variables
        content: |
          # Generated by Ansible at {{ lookup('pipe', 'hostname -f') }}
          # Any changes made here will be overwritten

          [Unit]
          Description=Wireguard wg-quick@{{ wg_client_service_name }} watchdog service
          Wants=wg-watchdog.timer
          [Service]
          Type=oneshot
          ExecStart=/opt/ansible/scripts/restart_wg_client.py {{ wg_client_service_name }}
        mode: "0644"
        owner: root
        group: root
      become: true
      notify:
        # [!!] Hanlders run in order they are defined, not in order they are listed in notify
        - Run daemon-reload for systemd

    - name: Create wireguard watchdog timer
      become: true
      ansible.builtin.copy:
        dest: /etc/systemd/system/wg-watchdog.timer
        # https://wiki.archlinux.org/title/Systemd/Timers
        content: |
          # Generated by Ansible at {{ lookup('pipe', 'hostname -f') }}
          # Any changes made here will be overwritten

          [Unit]
          Description=Wireguard wg-quick@{{ wg_client_service_name }} watchdog timer
          [Timer]
          # Run every 4 minutes
          OnUnitActiveSec=4m
          [Install]
          WantedBy=timers.target
        mode: "0644"
        owner: root
        group: root
      notify:
        # [!!] Hanlders run in order they are defined, not in order they are listed in notify
        - Run daemon-reload for systemd
        - Restart wg-watchdog.timer

    - name: Enable and start wireguard watchdog timer
      ansible.builtin.systemd:
        name: wg-watchdog.timer
        enabled: true
        state: started
      become: true

  handlers:
    - name: Run daemon-reload for systemd
      ansible.builtin.systemd:
        daemon_reload: true
      become: true

    - name: Restart wg-watchdog.timer
      ansible.builtin.systemd:
        name: wg-watchdog.timer
        state: restarted
      become: true
