---

- name: Write env variables file
  ansible.builtin.template:
    src: "env.j2"
    dest: "/opt/docker-configs/{{ docker_compose_config_to_init.key }}/.env"
    owner: root
    group: root
    mode: '0644'
  become: true
  when: docker_compose_config_to_init.value.env_variables is defined
  register: __dc_env_result

- name: Write local settings file
  ansible.builtin.copy:
    dest: "/opt/docker-configs/{{ docker_compose_config_to_init.key }}/docker-compose.local.yml"
    content: |
      # Generated by Ansible at {{ lookup('pipe', 'hostname -f') }}
      # Any changes made here will be overwritten
      {{ docker_compose_config_to_init.value.local_settings | to_nice_yaml(indent=2) }}
    mode: "0644"
    owner: root
    group: root
  become: true
  when: docker_compose_config_to_init.value.local_settings is defined
  register: __dc_local_settings_result

- name: Get local settings file info
  ansible.builtin.stat:
    path: "/opt/docker-configs/{{ docker_compose_config_to_init.key }}/docker-compose.local.yml"
  register: __dc_local_settings_file

- name: Construct docker compose command
  ansible.builtin.set_fact:
    __dc_compose_command: "docker compose -f docker-compose.yml{{ ' -f docker-compose.local.yml' if __dc_local_settings_file.stat.exists else '' }}"

- name: Get current config
  ansible.builtin.command:
    cmd: "{{ __dc_compose_command }} config --format json"
    chdir: "/opt/docker-configs/{{ docker_compose_config_to_init.key }}"
  become: true
  register: __dc_current_config
  changed_when: false

# NOTE: Here we list all services, not only running ones. This is because
#       a config may use "restart: unless-stopped" setting and services may
#       be down for a reason.
- name: List existing services
  ansible.builtin.command:
    cmd: "{{ __dc_compose_command }} ps --all --services"
    chdir: "/opt/docker-configs/{{ docker_compose_config_to_init.key }}"
  become: true
  register: __dc_containers
  changed_when: false

- name: Check if all services exist
  ansible.builtin.set_fact:
    _dc_all_services_exist: false
  when: _dc_service is not in __dc_containers.stdout_lines
  loop: "{{ (__dc_current_config.stdout | from_json).services.keys() }}"
  loop_control:
    loop_var: _dc_service

# We track config change, but don't apply changes because:
#   - this is a potentially destructive action and may require prior data backup;
#   - image version upgrade may require some manual actions;
- name: Check if service re-creation is needed
  when: _dc_all_services_exist and (__dc_env_result.changed or __dc_local_settings_result.changed)
  display_warning:
    msg: Not applying updated config as all services already exist. Use Docker compose down/up commands manually

- name: Create and run containers
  when: not _dc_all_services_exist
  ansible.builtin.command:
    cmd: "{{ __dc_compose_command }} up -d"
    chdir: "/opt/docker-configs/{{ docker_compose_config_to_init.key }}"
  become: true
  register: __dc_up_command_result

- name: Write current config
  when: __dc_up_command_result is not skipped
  block:
    - name: Make sure local data directory exists
      ansible.builtin.file:
        path: "/opt/docker-configs/{{ docker_compose_config_to_init.key }}/local-data"
        state: directory
        mode: "0755"
        owner: root
        group: root
      become: true

    # It would have been better to save JSON config, that we already have in
    # __dc_current_config variable, using copy module rather than frowned upon shell.
    # But strangely it appears to lose newline ans space characters when
    # using 'content' with a variable.
    # TODO: review and debug this when time permits
    #
    # - name: Write current config file
    #   ansible.builtin.copy:
    #     dest: "/opt/docker-configs/{{ docker_compose_config_to_init.key }}/local-data/config_{{ '%Y-%m-%d_%H-%M' | strftime }}.json"
    #     # content: "{{ __dc_current_config.stdout | join('\\n') }}"
    #     # content: "{{ __dc_current_config.stdout_lines | join('\n') }}"
    #     content: |
    #       {{ __dc_current_config.stdout }}
    #     mode: "0644"
    #     owner: root
    #     group: root
    #   become: true

    - name: Write current config file
      ansible.builtin.shell: |
        {{ __dc_compose_command }} config > local-data/config_{{ '%Y-%m-%d_%H-%M' | strftime }}.txt
      args:
        chdir: "/opt/docker-configs/{{ docker_compose_config_to_init.key }}"
      become: true
