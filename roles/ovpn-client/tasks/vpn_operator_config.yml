- name: Add VPN operator user
  ansible.builtin.user:
    name: "{{ ovpn_client_operator }}"
    password_lock: yes
  become: yes

- name: Read VPN operator's public key from private key file
  ansible.builtin.script:
    cmd: get_ssh_public_key.sh "{{ ovpn_client_operator_key }}"
  args:
    executable: /bin/bash
  delegate_to: localhost
  register: ovpn_client_operator_public_key
  changed_when: false

- name: Add SSH authorized key for VPN operator user
  ansible.posix.authorized_key:
    user: "{{ ovpn_client_operator }}"
    state: present
    key: "{{ ovpn_client_operator_public_key.stdout_lines[0] }}"
  become: yes

- name: Copy 'purevpn_change_country.py' script
  copy:
    src: purevpn_change_country.py
    dest: /etc/openvpn/client/purevpn_change_country.py
    mode: 0755
  become: true

- name: Allow passwordless sudo calls for VPN operator user
  copy:
    dest: "/etc/sudoers.d/vpn_operator"
    content: |
      # Generated by Ansible at {{ lookup('pipe', 'hostname -f') }}
      # Any changes made here will be overwritten

      # Allow VPN operator to run specific sudo commands without entering the password
      {{ ovpn_client_operator }} ALL=NOPASSWD: /etc/openvpn/client/purevpn_change_country.py
      {{ ovpn_client_operator }} ALL=NOPASSWD: /usr/bin/journalctl -u openvpn-client@{{ ovpn_client_server_type }}.service -f
      {{ ovpn_client_operator }} ALL=NOPASSWD: /usr/bin/systemctl restart openvpn-client@{{ ovpn_client_server_type }}.service
    owner: root
    group: root
    mode: u=rw,g=r,o-rwx
  become: yes
