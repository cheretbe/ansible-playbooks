---

- name: Make sure /etc/sudoers.d exists
  ansible.builtin.file:
    state: directory
    path: /etc/sudoers.d
    owner: root
    group: root
    mode: "0750"
  become: true

- name: Enable passwordless sudo for 'sudo' group
  ansible.builtin.copy:
    content: |
      # Generated by Ansible at {{ lookup('pipe', 'hostname -f') }}
      # Any changes made here will be overwritten
      %sudo ALL=(ALL:ALL) NOPASSWD:ALL
    dest: /etc/sudoers.d/00_passwordless_sudo
    mode: "0440"
    validate: "/usr/sbin/visudo -cf %s"
  become: true

- name: Set combined user list fact
  ansible.builtin.set_fact:
    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/varnames_lookup.html
    # The difference between lookup and query is largely that query will always return a list
    # https://docs.ansible.com/ansible/latest/plugins/lookup.html#forcing-lookups-to-return-lists-query-and-wantlist-true
    # "*" is used to dereference the list to a list of arguments
    _linux_users_combined_list: "{{ lookup('vars', *query('varnames', '^linux_users_list')) | flatten(levels=1) }}"

- name: Add users
  ansible.builtin.user:
    name: "{{ _linux_users_user_to_create.name }}"
    comment: "{{ _linux_users_user_to_create.comment | default(omit) }}"
    password: "{{ _linux_users_user_to_create.password | default(omit) }}"
    shell: "{{ _linux_users_user_to_create.shell | default(omit) }}"
    groups: "{{ _linux_users_user_to_create.groups | default(omit) }}"
    append: "{{ _linux_users_user_to_create.append | default(omit) }}"
  loop: "{{ _linux_users_combined_list }}"
  loop_control:
    loop_var: _linux_users_user_to_create
    label: "{{ _linux_users_user_to_create.name }}"
  become: true

- name: Add SSH authorized keys
  ansible.posix.authorized_key:
    user: "{{ _linux_users_user_to_create.name }}"
    key: "{{ _linux_users_user_to_create.ssh_authorized_key }}"
  when: _linux_users_user_to_create.ssh_authorized_key is defined
  loop: "{{ _linux_users_combined_list }}"
  loop_control:
    loop_var: _linux_users_user_to_create
    label: "{{ _linux_users_user_to_create.name }}"
  become: true
