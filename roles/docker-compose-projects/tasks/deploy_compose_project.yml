---

- name: "{{ _docker_compose_project.name }} - Make sure Docker Compose project directory exists"
  ansible.builtin.file:
    state: directory
    path: "{{ docker_compose_projects_target_dir }}/{{ _docker_compose_project.name }}"
    owner: root
    group: root
    mode: 0750
  become: true

- name: "{{ _docker_compose_project.name }} - Generate compose files"
  ansible.builtin.copy:
    content: |
      {% if (_deploy_compose_project_compose_file.ansible_managed_header | default(True)) %}
      ---

      # Generated by Ansible at {{ lookup('pipe', 'hostname -f') }}
      # Any changes made here will be overwritten

      {% endif %}
      {{ _deploy_compose_project_compose_file.content }}
    dest: "{{ docker_compose_projects_target_dir }}/{{ _docker_compose_project.name }}/{{ _deploy_compose_project_compose_file.filename }}"
    owner: root
    group: root
    mode: 0640
  loop: "{{ _docker_compose_project.compose_files }}"
  loop_control:
    loop_var: _deploy_compose_project_compose_file
    label: "{{ _deploy_compose_project_compose_file.filename }}"
  become: true

- name: "{{ _docker_compose_project.name }} - Generate .env file"
  ansible.builtin.copy:
    content: |
      # Generated by Ansible at {{ lookup('pipe', 'hostname -f') }}
      # Any changes made here will be overwritten

      COMPOSE_FILE="{{ _docker_compose_project.compose_files | map(attribute='filename') | join(':') }}"
      {% if _docker_compose_project.environment is defined %}

      {{ _docker_compose_project.environment }}
      {% endif %}
    dest: "{{ docker_compose_projects_target_dir }}/{{ _docker_compose_project.name }}/.env"
    owner: root
    group: root
    # May contain sensitive information hence 600 mask
    mode: 0600
  become: true

- name: "{{ _docker_compose_project.name }} - Deploy Docker Compose project"
  community.docker.docker_compose_v2:
    project_src: "{{ docker_compose_projects_target_dir }}/{{ _docker_compose_project.name }}"
    files: "{{ _docker_compose_project.compose_files | map(attribute='filename') }}"
  become: true
  check_mode: "{{ docker_compose_projects_generate_only | bool }}"
